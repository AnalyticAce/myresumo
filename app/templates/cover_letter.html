{% extends "base.html" %}

{% block title %}Cover Letter Composer - PowerCV{% endblock %}

{% block head %}
<style>
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .loading-spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #0ea5e9;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .editor-field {
        transition: all 0.2s ease;
    }
    
    .editor-field:focus {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .preview-content {
        white-space: pre-wrap;
        font-family: 'Georgia', serif;
        line-height: 1.6;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="coverLetterGenerator()" x-init="init()" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-900">Cover Letter Generator</h1>
        <p class="mt-2 text-gray-600">Generate professional cover letters from your resumes with one click</p>
    </div>

    <!-- Help Modal -->
    <div x-show="showHelp" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" @click.self="showHelp = false">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white fade-in">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">How to Use Cover Letter Composer</h3>
                <div class="space-y-3 text-sm text-gray-600">
                    <div class="flex items-start">
                        <span class="flex-shrink-0 w-6 h-6 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center text-xs font-medium mr-3">1</span>
                        <p>Fill in your personal information and the job details you're applying for.</p>
                    </div>
                    <div class="flex items-start">
                        <span class="flex-shrink-0 w-6 h-6 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center text-xs font-medium mr-3">2</span>
                        <p>Optionally link a resume to pull relevant information and experience.</p>
                    </div>
                    <div class="flex items-start">
                        <span class="flex-shrink-0 w-6 h-6 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center text-xs font-medium mr-3">3</span>
                        <p>Write your cover letter content in the structured sections provided.</p>
                    </div>
                    <div class="flex items-start">
                        <span class="flex-shrink-0 w-6 h-6 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center text-xs font-medium mr-3">4</span>
                        <p>Generate the final cover letter and download it as a PDF.</p>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button @click="showHelp = false" class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        Got it
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-2xl mx-auto">
        <!-- CV Selection -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Select Your CV</h2>

            <div x-show="loadingResumes" class="text-center py-4">
                <div class="loading-spinner mx-auto"></div>
                <p class="text-sm text-gray-500 mt-2">Loading your resumes...</p>
            </div>

            <div x-show="!loadingResumes" class="space-y-4">
                <select x-model="selectedResumeId" @change="loadResumeData()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Choose a resume to generate cover letter from</option>
                    <template x-for="resume in resumes" :key="resume.id">
                        <option :value="resume.id" x-text="resume.title"></option>
                    </template>
                </select>

                <div x-show="selectedResumeData" class="bg-gray-50 p-4 rounded-md">
                    <h3 class="font-medium text-gray-900 mb-2" x-text="selectedResumeData.title"></h3>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p x-show="selectedResumeData.target_company"><strong>Company:</strong> <span x-text="selectedResumeData.target_company"></span></p>
                        <p x-show="selectedResumeData.target_role"><strong>Position:</strong> <span x-text="selectedResumeData.target_role"></span></p>
                        <p><strong>Last updated:</strong> <span x-text="new Date(selectedResumeData.updated_at || selectedResumeData.created_at).toLocaleDateString()"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Details -->
        <div x-show="selectedResumeId" class="bg-white shadow rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Job Details</h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                    <input type="text" x-model="jobDetails.company" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter company name">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Position Title</label>
                    <input type="text" x-model="jobDetails.position" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter job position">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Job Description (Optional)</label>
                    <textarea x-model="jobDetails.description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Paste job description for better personalization..."></textarea>
                </div>
            </div>
        </div>

        <!-- Generate Button -->
        <div x-show="selectedResumeId && (jobDetails.company || jobDetails.position)" class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="text-center">
                <button @click="generateCoverLetter()" :disabled="generating" class="px-8 py-4 bg-blue-600 text-white text-lg font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!generating" class="flex items-center">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Generate Cover Letter
                    </span>
                    <span x-show="generating" class="flex items-center">
                        <div class="loading-spinner mr-3"></div>
                        Generating...
                    </span>
                </button>
                <p class="text-sm text-gray-600 mt-2">AI will create a personalized cover letter based on your resume</p>
            </div>
        </div>

        <!-- Results Section -->
        <div x-show="generatedCoverLetter" class="bg-white shadow rounded-lg p-6">
            <div class="text-center mb-6">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mt-2">Cover Letter Generated!</h3>
                <p class="text-sm text-gray-600">Your personalized cover letter is ready to download</p>
            </div>

            <!-- Cover Letter Preview -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6">
                <h4 class="font-medium text-gray-900 mb-4">Preview</h4>
                <div class="text-sm text-gray-800 whitespace-pre-wrap font-serif leading-relaxed max-h-96 overflow-y-auto" x-text="generatedCoverLetter"></div>
            </div>

            <!-- Download Button (Coming Soon) -->
            <div class="text-center">
                <button
                    type="button"
                    class="px-6 py-3 bg-gray-300 text-gray-600 font-medium rounded-lg cursor-not-allowed"
                    disabled
                    aria-disabled="true"
                    title="PDF download coming soon"
                >
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Download as PDF (coming soon)
                </button>
            </div>
        </div>

    </div>

    <!-- Help Modal (simplified) -->
    <div x-show="showHelp" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" @click.self="showHelp = false">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white fade-in">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">How to Generate Cover Letters</h3>
                <div class="space-y-3 text-sm text-gray-600">
                    <div class="flex items-start">
                        <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-3">1</span>
                        <p>Select one of your resumes from the dropdown</p>
                    </div>
                    <div class="flex items-start">
                        <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-3">2</span>
                        <p>Enter the company name and position you're applying for</p>
                    </div>
                    <div class="flex items-start">
                        <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-3">3</span>
                        <p>Click "Generate Cover Letter" - AI will create a personalized letter</p>
                    </div>
                    <div class="flex items-start">
                        <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-medium mr-3">4</span>
                        <p>Download your cover letter as a PDF</p>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button @click="showHelp = false" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Got it
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('coverLetterGenerator', () => ({
        // State
        resumes: [],
        selectedResumeId: '',
        selectedResumeData: null,
        loadingResumes: true,
        generating: false,
        generatedCoverLetter: '',
        showHelp: false,

        jobDetails: {
            company: '',
            position: '',
            description: ''
        },

        // Initialize
        async init() {
            await this.loadResumes();
        },

        // Load user's resumes
        async loadResumes() {
            try {
                const response = await fetch('/api/resume/user/local-user');
                if (response.ok) {
                    this.resumes = await response.json();
                }
            } catch (error) {
                console.error('Error loading resumes:', error);
                this.showToast('Error loading resumes', 'error');
            } finally {
                this.loadingResumes = false;
            }
        },

        // Load selected resume data
        async loadResumeData() {
            if (!this.selectedResumeId) {
                this.selectedResumeData = null;
                return;
            }

            try {
                const response = await fetch(`/api/resume/${this.selectedResumeId}`);
                if (response.ok) {
                    this.selectedResumeData = await response.json();
                    // Pre-fill job details if available
                    if (this.selectedResumeData.target_company) {
                        this.jobDetails.company = this.selectedResumeData.target_company;
                    }
                    if (this.selectedResumeData.target_role) {
                        this.jobDetails.position = this.selectedResumeData.target_role;
                    }
                    if (this.selectedResumeData.job_description) {
                        this.jobDetails.description = this.selectedResumeData.job_description;
                    }
                }
            } catch (error) {
                console.error('Error loading resume data:', error);
                this.showToast('Error loading resume data', 'error');
            }
        },

        // Generate cover letter
        async generateCoverLetter() {
            if (!this.selectedResumeId || !this.jobDetails.company || !this.jobDetails.position) {
                this.showToast('Please select a resume and fill in company and position', 'warning');
                return;
            }

            this.generating = true;

            try {
                const response = await fetch(`/api/resume/${this.selectedResumeId}/cover-letter`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        company: this.jobDetails.company,
                        position: this.jobDetails.position,
                        job_description: this.jobDetails.description
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    this.generatedCoverLetter = data.cover_letter || 'Cover letter generated successfully!';
                    this.showToast('Cover letter generated successfully!', 'success');
                } else {
                    throw new Error('Failed to generate cover letter');
                }
            } catch (error) {
                console.error('Error generating cover letter:', error);
                this.showToast('Error generating cover letter. Please try again.', 'error');
            } finally {
                this.generating = false;
            }
        },

        // Download cover letter as PDF
        downloadCoverLetter() {
            // For now, just show a message. In a real implementation, this would generate a PDF
            this.showToast('PDF download feature coming soon!', 'info');
        },

        // Toast notification helper
        showToast(message, type = 'info') {
            // Use the global toast system if available
            if (window.showToast) {
                window.showToast(message, type);
            } else {
                alert(message);
            }
        }
    }));
});
</script>

{% endblock %}
